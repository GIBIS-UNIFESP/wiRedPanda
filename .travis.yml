language: cpp
cache: apt
cache:
  directories:
    - $HOME/Library/Caches/Homebrew
    - /usr/local/opt/qt5/
    - /opt/qt57/
os:
  - linux
  - osx

dist: trusty

env:
  - QT=qt57
  
addons:
apt:
  sources:
  - ubuntu-toolchain-r-test
  packages:
  - gcc-4.8
  - g++-4.8

branches:
  only:
    - 'master'

# before_install:
#   - export DISPLAY=:99.0
#   - sh -e /etc/init.d/xvfb start
before_install:
  - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
      if [ "$QT" = "qt57" ]; then sudo add-apt-repository ppa:beineri/opt-qt57-trusty -y; fi
      && sudo apt-get update;
    else
      brew update;
    fi

install:
  - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
     # if [ "$CXX" = "g++" ]; then sudo apt-get install -qq g++-4.8; fi
      #&& if [ "$CXX" = "g++" ]; then export CXX="g++-4.8" CC="gcc-4.8"; fi
      
      if [ "$QT" = "qt57" ] && [ ! -d /opt/qt57 ]; then
        sudo apt-get install -y qt57base qt57charts-no-lgpl
        && source /opt/qt57/bin/qt57-env.sh;
      fi;
    else
      brew install qt@5.7
      && ls /usr/local/opt/
      && chmod -R 755 /usr/local/opt/qt5/*;
    fi

before_script:
  - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
      export DISPLAY=:99.0
      && sh -e /etc/init.d/xvfb start
      && sleep 3;
    fi

script:
  - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
      g++ -v;
    else
      clang --version
      && locate qmake
      && ls "/usr/local/opt/"
      && QTDIR="/usr/local/opt/qt5"
      && PATH="${QTDIR}/bin:$PATH"
      && LDFLAGS=-L${QTDIR}/lib
      && CPPFLAGS=-I${QTDIR}/include;
    fi
  - qmake -v
  - qmake ./test/test.pro -r
  - make -j4
  - if [ "${TRAVIS_OS_NAME}" = "linux" ];
      then ./WPanda-test;
    else
      WPanda-test.app/Contents/MacOS/WPanda-test;
    fi
